<body>
    <h1>Friends Insights</h1>

    <input type="text" id="searchBar" placeholder="Search friends..." oninput="searchFriends()">

    <div id="buttons-container">
        <button id="friendsButton" onclick="loadFriends()">Friends</button>
        <button id="topContributorsButton" onclick="loadTopContributors()">Top Contributors</button>
        <button id="activeFriendsButton" onclick="loadActiveFriends()">Active Friend</button>
    </div>

    <ul id="friendsList" class="friend-list"></ul>

    <script>
        let currentList = 'friends'; // Default to friends list

        async function loadFriends() {
            currentList = 'friends';
            fetchFriends('/friend/list');
        }

        async function loadTopContributors() {
            try {
                const response = await fetch('/friend/top-contributors');
                const contributors = await response.json();
                const userId = '<%= user._id %>'; // Include the current user's ID in the EJS template
        
                const friendsList = document.getElementById('friendsList');
                friendsList.innerHTML = ''; // Clear previous entries
        
                contributors
                    .filter(contributor => contributor.friend._id !== userId) // Exclude the logged-in user
                    .forEach(contributor => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <img src="${contributor.friend.profileImage || '/path/to/default-profile.png'}" alt="Profile Image" width="30" height="30">
                            ${contributor.friend.username} - Total Shared: ${contributor.totalSharedContent} (Posts: ${contributor.sharedPostCount}, Stories: ${contributor.sharedStoryCount})
                        `;
                        friendsList.appendChild(li);
                    });
            } catch (error) {
                console.error("Error loading top contributors:", error);
            }
        }
        

        async function loadActiveFriends() {
            try {
                const response = await fetch('/friend/active-friends'); // API to fetch most active friends
                const activeFriends = await response.json();
        
                const friendsList = document.getElementById('friendsList');
                friendsList.innerHTML = ''; // Clear previous list
        
                if (activeFriends && activeFriends.length > 0) {
                    activeFriends.forEach(friend => {
                        if (friend && friend.friend) {
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <img src="${friend.friend.profileImage || '/uploads/default-profile.png'}" alt="Profile Image" width="30" height="30">
                                ${friend.friend.username} - 
                                Likes: ${friend.likeCount}, Comments: ${friend.commentCount}, Dislikes: ${friend.dislikeCount}
                            `;
                            friendsList.appendChild(li);
                        }
                    });
                } else {
                    friendsList.innerHTML = `<li>No active friends found in your list</li>`;
                }
            } catch (error) {
                console.error("Error loading active friends:", error.message);
            }
        }
        async function fetchFriends(endpoint) {
            try {
                const response = await fetch(endpoint);
                const friends = await response.json();
                displayFriends(friends);
            } catch (error) {
                console.error("Error loading friends:", error);
            }
        }

        function displayFriends(friends) {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = ''; // Clear the list
            friends.forEach(friend => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <img src="${friend.friend.profileImage}" alt="Profile" width="30" height="30">
                    ${friend.friend.username}
                    <button onclick="removeFriend('${friend.friend._id}')">Remove</button>
                `;
                friendsList.appendChild(li);
            });
        }

        async function searchFriends() {
            const query = document.getElementById('searchBar').value.toLowerCase();
            const response = await fetch(`/friend/search-friends?type=${currentList}&query=${query}`);
            const filteredFriends = await response.json();
            displayFriends(filteredFriends);
        }

        async function removeFriend(friendId) {
            try {
                const response = await fetch('/friend/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ friendId }),
                });
                if (response.ok) {
                    if (currentList === 'friends') loadFriends();
                    else if (currentList === 'top-contributors') loadTopContributors();
                    else if (currentList === 'active-friends') loadActiveFriends();
                }
            } catch (error) {
                console.error("Error removing friend:", error);
            }
        }

        window.onload = loadFriends; // Load friends list by default
    </script>
</body>
